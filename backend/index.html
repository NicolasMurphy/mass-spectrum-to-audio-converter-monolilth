<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mass Spectrum to Audio Converter</title>
  </head>
  <body>
    <p>Hey!</p>
    <p>What are you doing?</p>
    <p>This is the dev testing sandbox!</p>
    <p>Go check out the frontend over here!</p>

    <a
      href="https://mass-spectrum-to-audio-converter.vercel.app/"
      target="_blank"
    >
      https://mass-spectrum-to-audio-converter.vercel.app/
    </a>
    <h1>Mass Spectrum to Audio Converter</h1>

    <label for="compoundInput">Compound Name</label><br />
    <input
      type="text"
      id="compoundInput"
      placeholder="e.g. biotin"
    /><br /><br />

    <label for="algorithmInput">Select algorithm:</label><br />
    <input
      type="radio"
      id="linearInput"
      name="algorithm"
      value="linear"
      checked
    />
    <label for="linearInput">Linear (m/z + offset)</label><br />
    <!-- <input
      type="radio"
      id="logarithmicInput"
      name="algorithm"
      value="logarithmic"
    />
    <label for="logarithmic">Logarithmic</label>
    <br /><br /> -->
    <input type="radio" id="inverseInput" name="algorithm" value="inverse" />
    <label for="inverseInput">Inverse (scale / (m/z + shift))</label>
    <br /><br />

    <label for="offsetInput">Offset (m/z) (linear only)</label><br />
    <input
      type="number"
      id="offsetInput"
      placeholder="e.g. 300"
      value="300"
    /><br /><br />

    <!-- <label for="logShiftInput">Log Shift (logarithmic only)</label><br />
    <input
      type="number"
      id="logShiftInput"
      placeholder="e.g. 1"
      value="1"
    /><br /><br />

    <label for="scaleInput">Scale (logarithmic only)</label><br />
    <input
      type="number"
      id="scaleInput"
      placeholder="e.g. 300"
      value="300"
    /><br /><br /> -->

    <label for="scaleInput">Scale (inverse only)</label><br />
    <input
      type="number"
      id="scaleInput"
      placeholder="e.g. 100000"
      value="100000"
    /><br /><br />

    <label for="shiftInput">Shift (inverse only)</label><br />
    <input
      type="number"
      id="shiftInput"
      placeholder="e.g. 1"
      value="1"
    /><br /><br />

    <label for="durationInput">Duration</label><br />
    <input
      type="number"
      id="durationInput"
      placeholder="e.g. 5"
      value="5"
    /><br /><br />

    <label for="sampleRateInput">Sample Rate (Hz)</label><br />
    <input
      type="number"
      id="sampleRateInput"
      placeholder="e.g. 96000"
      value="96000"
    /><br /><br />

    <button onclick="fetchAudio()">Generate Audio</button>

    <!-- testing POST -->
    <button onclick="testPostEndpoint()">Test New POST Endpoint</button>

    <h4>Request Body Sent:</h4>
    <pre
      id="requestBody"
      style="background: #e8f4fd; padding: 10px; font-size: 12px; display: none"
    ></pre>

    <h3>POST Response:</h3>
    <pre
      id="postResponse"
      style="
        background: #f5f5f5;
        padding: 10px;
        font-size: 12px;
        display: none;
        max-height: 300px;
        overflow-y: auto;
      "
    ></pre>

    <div id="spectrumData" style="display: none">
      <h4>Spectrum Data (m/z â†’ frequency transformations):</h4>
      <table
        border="1"
        id="spectrumTable"
        style="font-size: 12px; border-collapse: collapse"
      >
        <thead>
          <tr>
            <th style="padding: 5px">m/z</th>
            <th style="padding: 5px">Frequency (Hz)</th>
            <th style="padding: 5px">Intensity</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p id="status"></p>
    <p id="metaInfo" style="display: none"></p>
    <audio id="audioPlayer" controls style="display: none"></audio>
    <a id="downloadLink" style="display: none">Download WAV</a>
    <p>query URL:</p>
    <p id="rawUrl" style="font-family: monospace; color: #555"></p>

    <h2>Recent Searches</h2>
    <ul id="history-list"></ul>

    <script>
      async function fetchAudio() {
        const compound = document.getElementById("compoundInput").value.trim();
        const algorithmInput = document.querySelector(
          'input[name="algorithm"]:checked'
        );
        const algorithm = algorithmInput ? algorithmInput.value : "linear";
        const offset = document.getElementById("offsetInput").value.trim();
        // const logShift = document.getElementById("logShiftInput").value.trim();
        // const scale = document.getElementById("scaleInput").value.trim();
        const scale = document.getElementById("scaleInput").value.trim();
        const shift = document.getElementById("shiftInput").value.trim();
        const duration = document.getElementById("durationInput").value.trim();
        const sampleRate = document
          .getElementById("sampleRateInput")
          .value.trim();

        const status = document.getElementById("status");
        const metaInfo = document.getElementById("metaInfo");
        const audio = document.getElementById("audioPlayer");
        const link = document.getElementById("downloadLink");

        status.textContent = "Fetching audio...";
        audio.style.display = "none";
        link.style.display = "none";
        metaInfo.style.display = "none";

        try {
          // not the most DRY approach, but keeps ordering consistent
          // database -> algorithm -> compound -> offset -> scale -> shift -> duration -> sample rate
          let queryUrl = ``;
          if (algorithm === "linear") {
            queryUrl = `/massbank/${algorithm}?compound=${encodeURIComponent(
              compound
            )}&offset=${offset}&duration=${duration}&sample_rate=${sampleRate}`;
            // } else if (algorithm === "logarithmic") {
            //  queryUrl = `/massbank/${algorithm}?compound=${encodeURIComponent(
            //    compound
            //  )}&logShift=${logShift}&scale=${scale}&duration=${duration}&sample_rate=${sampleRate}`;
          } else if (algorithm === "inverse") {
            queryUrl = `/massbank/${algorithm}?compound=${encodeURIComponent(
              compound
            )}&scale=${scale}&shift=${shift}&duration=${duration}&sample_rate=${sampleRate}`;
          }

          document.getElementById("rawUrl").textContent = queryUrl;

          const response = await fetch(queryUrl);

          if (!response.ok) {
            const error = await response.json();
            status.textContent = `Error ${response.status}: ${error.error}`;
            return;
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);

          // extract metadata from headers
          const compoundName = response.headers.get("X-Compound") || compound;
          const accession = response.headers.get("X-Accession") || "unknown";

          // update metadata display
          const accessionUrl = `https://massbank.eu/MassBank/RecordDisplay?id=${accession}`;
          metaInfo.innerHTML = `Compound: ${compoundName} | Accession: <a href="${accessionUrl}" target="_blank">${accession}</a>`;

          metaInfo.style.display = "block";

          // Set audio player
          audio.src = url;
          audio.style.display = "block";

          // Set download link using compound-accession format
          link.href = url;
          link.download = `${compoundName}-${accession}.wav`;
          link.textContent = "Download WAV";
          link.style.display = "inline";

          status.textContent = "Success!";
        } catch (e) {
          status.textContent = `Error: ${e.message}`;
        }
      }
      document // user clicks enter to generate audio
        .getElementById("compoundInput")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter") {
            fetchAudio();
          }
        });

      // testing POST
      async function testPostEndpoint() {
        // Reuse all the existing form reading logic
        const compound = document.getElementById("compoundInput").value.trim();
        const algorithmInput = document.querySelector(
          'input[name="algorithm"]:checked'
        );
        const algorithm = algorithmInput ? algorithmInput.value : "linear";
        const offset = document.getElementById("offsetInput").value.trim();
        const scale = document.getElementById("scaleInput").value.trim();
        const shift = document.getElementById("shiftInput").value.trim();
        const duration = document.getElementById("durationInput").value.trim();
        const sampleRate = document
          .getElementById("sampleRateInput")
          .value.trim();

        // Prepare request body based on algorithm
        let requestBody = {
          compound: compound,
          duration: duration,
          sample_rate: sampleRate,
        };

        if (algorithm === "linear") {
          requestBody.offset = offset;
        } else if (algorithm === "inverse") {
          requestBody.scale = scale;
          requestBody.shift = shift;
        }

        const postResponse = document.getElementById("postResponse");
        const spectrumData = document.getElementById("spectrumData");

        postResponse.textContent = "Loading...";
        postResponse.style.display = "block";
        spectrumData.style.display = "none";

        document.getElementById("requestBody").textContent = JSON.stringify(
          requestBody,
          null,
          2
        );
        document.getElementById("requestBody").style.display = "block";

        try {
          const response = await fetch(`/massbank/${algorithm}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            const error = await response.json();
            postResponse.textContent = `Error ${
              response.status
            }: ${JSON.stringify(error, null, 2)}`;
            return;
          }

          const data = await response.json();

          // Display raw JSON response
          postResponse.textContent = JSON.stringify(data, null, 2);

          // Display spectrum data in table
          if (data.spectrum && data.spectrum.transformed) {
            const tableBody = document.querySelector("#spectrumTable tbody");
            tableBody.innerHTML = ""; // Clear existing rows

            data.spectrum.transformed.forEach((item) => {
              const row = tableBody.insertRow();
              row.insertCell(0).textContent = item.mz.toFixed(4);
              row.insertCell(1).textContent = item.frequency.toFixed(2);
              row.insertCell(2).textContent = item.intensity.toLocaleString();
            });

            spectrumData.style.display = "block";
          }
        } catch (e) {
          postResponse.textContent = `Error: ${e.message}`;
        }
      }

      async function loadHistory() {
        try {
          const res = await fetch("/history");
          const data = await res.json();

          const list = document.getElementById("history-list");
          list.innerHTML = "";

          data.history.forEach((entry) => {
            const date = new Date(entry.created_at).toLocaleString();
            const li = document.createElement("li");
            li.textContent = `${entry.compound} - (${entry.accession}) - ${date}`;
            list.appendChild(li);
          });
        } catch (err) {
          console.error("Failed to load history:", err);
        }
      }

      window.addEventListener("DOMContentLoaded", loadHistory);
    </script>
  </body>
</html>

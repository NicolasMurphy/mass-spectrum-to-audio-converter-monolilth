<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mass Spectrum to Audio Converter</title>
  </head>
  <body>
    <p>Hey!</p>
    <p>What are you doing?</p>
    <p>This is the dev testing sandbox!</p>
    <p>Go check out the frontend over here!</p>

    <a
      href="https://mass-spectrum-to-audio-converter.vercel.app/"
      target="_blank"
    >
      https://mass-spectrum-to-audio-converter.vercel.app/
    </a>
    <h1>Mass Spectrum to Audio Converter</h1>

    <label for="compoundInput">Compound Name</label><br />
    <input
      type="text"
      id="compoundInput"
      placeholder="e.g. biotin"
    /><br /><br />

    <label for="algorithmInput">Select algorithm:</label><br />
    <input
      type="radio"
      id="linearInput"
      name="algorithm"
      value="linear"
      checked
    />
    <label for="linearInput">Linear</label><br />
    <input
      type="radio"
      id="logarithmicInput"
      name="algorithm"
      value="logarithmic"
    />
    <label for="logarithmic">Logarithmic</label>
    <br /><br />

    <label for="offsetInput">Offset (m/z) (linear only)</label><br />
    <input
      type="number"
      id="offsetInput"
      placeholder="e.g. 300"
      value="300"
    /><br /><br />

    <label for="logShiftInput">Log Shift (logarithmic only)</label><br />
    <input
      type="number"
      id="logShiftInput"
      placeholder="e.g. 1"
      value="1"
    /><br /><br />

    <label for="scaleInput">Scale (logarithmic only)</label><br />
    <input
      type="number"
      id="scaleInput"
      placeholder="e.g. 300"
      value="300"
    /><br /><br />

    <label for="durationInput">Duration</label><br />
    <input
      type="number"
      id="durationInput"
      placeholder="e.g. 5"
      value="5"
    /><br /><br />

    <label for="sampleRateInput">Sample Rate (Hz)</label><br />
    <input
      type="number"
      id="sampleRateInput"
      placeholder="e.g. 96000"
      value="96000"
    /><br /><br />

    <button onclick="fetchAudio()">Generate Audio</button>

    <p id="status"></p>
    <p id="metaInfo" style="display: none"></p>
    <audio id="audioPlayer" controls style="display: none"></audio>
    <a id="downloadLink" style="display: none">Download WAV</a>
    <p>query URL:</p>
    <p id="rawUrl" style="font-family: monospace; color: #555"></p>

    <script>
      async function fetchAudio() {
        const compound = document.getElementById("compoundInput").value.trim();
        const algorithmInput = document.querySelector(
          'input[name="algorithm"]:checked'
        );
        const algorithm = algorithmInput ? algorithmInput.value : "linear";
        const offset = document.getElementById("offsetInput").value.trim();
        const logShift = document.getElementById("logShiftInput").value.trim();
        const scale = document.getElementById("scaleInput").value.trim();
        const duration = document.getElementById("durationInput").value.trim();
        const sampleRate = document
          .getElementById("sampleRateInput")
          .value.trim();

        const status = document.getElementById("status");
        const metaInfo = document.getElementById("metaInfo");
        const audio = document.getElementById("audioPlayer");
        const link = document.getElementById("downloadLink");

        if (!compound) {
          status.textContent = "Please enter a compound name.";
          return;
        }

        status.textContent = "Fetching audio...";
        audio.style.display = "none";
        link.style.display = "none";
        metaInfo.style.display = "none";

        try {
          // not the most DRY approach, but keeps ordering consistent
          // database -> algorithm -> compound -> offset -> log shift -> scale -> duration -> sample rate
          let queryUrl = ``;
          if (algorithm === "linear") {
            queryUrl = `/massbank/${algorithm}?compound=${encodeURIComponent(
              compound
            )}&offset=${offset}&duration=${duration}&sample_rate=${sampleRate}`;
          } else if (algorithm === "logarithmic") {
            queryUrl = `/massbank/${algorithm}?compound=${encodeURIComponent(
              compound
            )}&logShift=${logShift}&scale=${scale}&duration=${duration}&sample_rate=${sampleRate}`;
          }

          document.getElementById("rawUrl").textContent = queryUrl;

          const response = await fetch(queryUrl);

          if (!response.ok) {
            const error = await response.json();
            status.textContent = `Error: ${error.error}`;
            return;
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);

          // extract metadata from headers
          const compoundName = response.headers.get("X-Compound") || compound;
          const accession = response.headers.get("X-Accession") || "unknown";

          // update metadata display
          const accessionUrl = `https://massbank.eu/MassBank/RecordDisplay?id=${accession}`;
          metaInfo.innerHTML = `Compound: ${compoundName} | Accession: <a href="${accessionUrl}" target="_blank">${accession}</a>`;

          metaInfo.style.display = "block";

          // Set audio player
          audio.src = url;
          audio.style.display = "block";

          // Set download link using compound-accession format
          link.href = url;
          link.download = `${compoundName}-${accession}.wav`;
          link.textContent = "Download WAV";
          link.style.display = "inline";

          status.textContent = "Success!";
        } catch (e) {
          status.textContent = `Error: ${e.message}`;
        }
      }
      document // user clicks enter to generate audio
        .getElementById("compoundInput")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter") {
            fetchAudio();
          }
        });
    </script>
  </body>
</html>
